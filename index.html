<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katman YayÄ±n GeÃ§miÅŸi ArÅŸiv</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React ve ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK (Compat versiyonu) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            950: '#020617',
                            900: '#0f172a',
                            800: '#1e293b',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideInRight: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .aurora-glow {
            position: absolute; width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(99,102,241,0.15) 0%, rgba(0,0,0,0) 70%);
            border-radius: 50%; filter: blur(80px); z-index: -1;
            animation: aurora 15s infinite alternate; pointer-events: none;
        }
        @keyframes aurora {
            0% { transform: translate(-20%, -20%) scale(1); opacity: 0.5; }
            100% { transform: translate(-10%, 20%) scale(0.9); opacity: 0.5; }
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="text-slate-100 antialiased overflow-x-hidden min-h-screen flex flex-col">
    
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="aurora-glow top-[-200px] left-[-200px] bg-indigo-500/20"></div>
        <div class="aurora-glow bottom-[-200px] right-[-200px] bg-purple-500/10 delay-1000"></div>
    </div>

    <a 
        href="https://www.instagram.com/tinitavolkan/" 
        target="_blank" 
        rel="noopener noreferrer"
        class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 flex items-center gap-3 px-8 py-3.5 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white transition-all duration-300 shadow-xl shadow-purple-600/40 hover:scale-105 animate-slide-up border border-white/10 group"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="group-hover:rotate-6 transition-transform">
            <rect width="20" height="20" x="2" y="2" rx="5" ry="5" />
            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" />
            <line x1="17.5" x2="17.51" y1="6.5" y2="6.5" />
        </svg>
        <span class="text-sm font-bold tracking-wide">Instagram'da Takip Et</span>
    </a>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE KURULUMU ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVhRw5lEIrJ5cFjJS1D86AvJeAI67ja0Q",
            authDomain: "site-comments-ed18f.firebaseapp.com",
            projectId: "site-comments-ed18f",
            storageBucket: "site-comments-ed18f.firebasestorage.app",
            messagingSenderId: "587969670836",
            appId: "1:587969670836:web:de8f614bbcafa0ed2b1e1"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();

        db.settings({
          experimentalForceLongPolling: true,
          useFetchStreams: false
        });

        const CATEGORIES = [
            { id: 'all', name: 'TÃ¼m ArÅŸiv' },
            { id: 'Hype', name: 'Hype' },
            { id: 'Triel', name: 'Triel' },
            { id: 'Sinasi', name: 'Åinasi' }, 
            { id: 'Prensesperver', name: 'Prensesperver' },
            { id: 'Nuriben', name: 'Nuriben' },
            { id: 'Nesrin', name: 'Nesrin' },
            { id: 'Egearseven', name: 'Egearseven' },
            { id: 'Blush', name: 'Blush' }
        ];

        const FALLBACK_DATA = {
            "tarih": "02.01.2026",
            "videos": [
                { "title": "Blush 15.12.2025 1", "embed_id": "v71l1b4", "link": "https://rumble.com/v71l1b4-blush.html" }, 
                { "title": "Blush 15.12.2025 2_Parca_000", "embed_id": "v71l1b5", "link": "https://rumble.com/v71l1b5-blush.html" }
            ]
        };

        // --- Utility Functions ---
        const cleanSearch = (val) => (val || '').replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/\u00A0/g, ' ').trim();
        const normalizeText = (str) => {
            return str.toString().toLowerCase()
                .replace('ÄŸ', 'g').replace('Ã¼', 'u').replace('ÅŸ', 's')
                .replace('Ä±', 'i').replace('Ã¶', 'o').replace('Ã§', 'c');
        };

        const processVideoData = (rawVideos) => {
            const getSortParts = (title) => {
                const match = title.match(/(\d+)\s*_Parca_\s*(\d+)/);
                if (match) return { mainPart: parseInt(match[1], 10), subPart: parseInt(match[2], 10) };
                return { mainPart: 0, subPart: 0 };
            };

            const processed = rawVideos.map((v, index) => {
                const dateMatch = v.title.match(/(\d{2})\.(\d{2})\.(\d{4})/);
                const date = dateMatch ? new Date(dateMatch[3], dateMatch[2] - 1, dateMatch[1]) : new Date();
                const normalizedTitle = normalizeText(v.title);
                let category = "DiÄŸer";
                for (let cat of CATEGORIES) {
                    if (cat.id === 'all') continue;
                    const normalizedCat = normalizeText(cat.id);
                    if (normalizedTitle.includes(normalizedCat)) {
                        category = cat.name;
                        break;
                    }
                }
                return {
                    id: v.embed_id || index, 
                    title: v.title,
                    embedId: v.embed_id, 
                    date: date,
                    category: category,
                    sortMetrics: getSortParts(v.title)
                };
            });

            processed.sort((a, b) => {
                const dateDiff = b.date - a.date;
                if (dateDiff !== 0) return dateDiff;
                if (a.sortMetrics.mainPart !== b.sortMetrics.mainPart) return a.sortMetrics.mainPart - b.sortMetrics.mainPart;
                return a.sortMetrics.subPart - b.sortMetrics.subPart;
            });
            return processed;
        };

        const getTxtPath = (title) => {
            let cleanTitle = title.replace(/\.html$/, '');
            let filename = cleanTitle + ".txt";
            return `text/${filename}`;
        };

        const getCategoryName = (id) => {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.name : id;
        };

        // --- METÄ°N Ä°ÅLEME (TIMESTAMP LINKLEME) ---
        const linkifyTimestamps = (text, onSeek) => {
            if (!text) return text;
            
            const timeRegex = /(\d{1,2}):(\d{2})(?::(\d{2}))?/g;
            const parts = [];
            let lastIndex = 0;
            let match;

            timeRegex.lastIndex = 0;

            while ((match = timeRegex.exec(text)) !== null) {
                if (match.index > lastIndex) {
                    parts.push(text.substring(lastIndex, match.index));
                }

                const [fullMatch, h, m, s] = match;
                let seconds = 0;
                
                if (s !== undefined) {
                    seconds = parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(s);
                } else {
                    seconds = parseInt(h) * 60 + parseInt(m);
                }

                parts.push(
                    <span 
                        key={`time-${match.index}`}
                        onClick={() => onSeek(seconds)}
                        className="text-indigo-400 cursor-pointer hover:text-indigo-300 hover:underline font-mono bg-indigo-500/10 px-1 rounded transition-colors select-none"
                        title="Videonun bu anÄ±na git"
                    >
                        {fullMatch}
                    </span>
                );

                lastIndex = timeRegex.lastIndex;
            }

            if (lastIndex < text.length) {
                parts.push(text.substring(lastIndex));
            }

            return parts.length === 0 ? text : parts;
        };

        // --- YORUM REHBERÄ° ---
        const CommentGuideBox = () => (
            <div className="rounded-2xl bg-gradient-to-br from-indigo-900/30 to-slate-900/40 border border-indigo-500/20 overflow-hidden animate-fade-in mt-6">
                <div className="p-6">
                    <div className="flex items-center gap-3 mb-4">
                        <div className="p-2 bg-indigo-500/20 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </div>
                        <h3 className="text-xl font-bold text-white">Yorum Ã–zellikleri</h3>
                    </div>
                    
                    <div className="space-y-3">
                        <div className="flex items-start gap-3">
                            <div className="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span className="text-xs font-bold text-white">1</span>
                            </div>
                            <p className="text-slate-300 text-sm leading-relaxed">
                                VideolarÄ±n iÃ§indeki <strong className="text-indigo-300">anlÄ±k zamanlarÄ±</strong> paylaÅŸabilirsin.
                            </p>
                        </div>
                        <div className="flex items-start gap-3">
                            <div className="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span className="text-xs font-bold text-white">2</span>
                            </div>
                            <p className="text-slate-300 text-sm leading-relaxed">
                                Yorumun iÃ§ine <span className="font-mono text-white bg-indigo-500/20 px-1.5 py-0.5 rounded text-xs">12:30</span> veya <span className="font-mono text-white bg-indigo-500/20 px-1.5 py-0.5 rounded text-xs">01:45:00</span> formatÄ±nda zaman yazarsan, sistem bunu otomatik olarak <span className="text-indigo-400">tÄ±klanabilir</span> bir linke Ã§evirir.
                            </p>
                        </div>
                        <div className="flex items-start gap-3">
                            <div className="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span className="text-xs font-bold text-white">3</span>
                            </div>
                            <p className="text-slate-300 text-sm leading-relaxed">
                                Link'e tÄ±klandÄ±ÄŸÄ±nda video otomatik olarak o saniyeye gider ve oynamaya baÅŸlar.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- FIREBASE YORUM BÄ°LEÅENÄ° ---
        const CommentSection = ({ videoId, onSeek }) => {
            const [comments, setComments] = useState([]);
            const [nickname, setNickname] = useState('');
            const [text, setText] = useState('');
            const [isPosting, setIsPosting] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const savedNick = localStorage.getItem('katman_user_nickname');
                if (savedNick) setNickname(savedNick);
            }, []);

            useEffect(() => {
                if (!videoId) return;
                setIsLoading(true);

                const q = db.collection("comments").where("videoId", "==", videoId);

                const unsubscribe = q.onSnapshot((snapshot) => {
                    const fetchedComments = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data.createdAt ? data.createdAt.toDate() : new Date();
                        fetchedComments.push({
                            id: doc.id,
                            ...data,
                            displayDate: date
                        });
                    });
                    
                    fetchedComments.sort((a, b) => a.displayDate - b.displayDate);
                    
                    setComments(fetchedComments);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Yorumlar yÃ¼klenirken HATA:", error);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [videoId]);

            const handlePost = async () => {
                if (!nickname.trim()) {
                    alert("LÃ¼tfen bir takma ad (nickname) belirleyin.");
                    return;
                }
                if (!text.trim()) {
                    alert("Yorum boÅŸ olamaz.");
                    return;
                }
                setIsPosting(true);

                try {
                    await db.collection("comments").add({
                        videoId: videoId, 
                        nickname: nickname.trim(),
                        text: text.trim(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    localStorage.setItem('katman_user_nickname', nickname.trim());
                    setText(''); 
                } catch (error) {
                    console.error("Yorum gÃ¶nderilemedi:", error);
                    alert("HATA: " + error.message);
                } finally {
                    setIsPosting(false);
                }
            };

            const formatDate = (dateObj) => {
                return new Intl.DateTimeFormat('tr-TR', { 
                    day: '2-digit', month: 'long', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                }).format(dateObj);
            };

            if (!videoId) return null;

            return (
                <div className="mt-6 rounded-2xl bg-slate-900/40 border border-white/5 overflow-hidden animate-slide-up">
                    <div className="p-4 border-b border-white/5 flex items-center justify-between bg-white/5">
                        <h3 className="font-bold text-white flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            Yorumlar <span className="text-xs font-normal text-slate-400 ml-1">({comments.length})</span>
                        </h3>
                        <div className="text-[10px] text-indigo-300 bg-indigo-500/10 px-2 py-1 rounded border border-indigo-500/20">
                            ğŸ”´ CanlÄ± BaÄŸlantÄ±
                        </div>
                    </div>

                    <div className="p-4 space-y-4">
                        <div className="flex flex-col gap-3">
                            <input 
                                type="text" 
                                placeholder="Takma AdÄ±n (Nick)" 
                                value={nickname}
                                onChange={(e) => setNickname(e.target.value)}
                                className="bg-slate-950/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all placeholder:text-slate-600"
                            />
                            
                            <textarea 
                                placeholder="Videonun bu anÄ± hakkÄ±nda ne dÃ¼ÅŸÃ¼nÃ¼yorsun? Ã–rneÄŸin: 12:30'daki espri Ã§ok gÃ¼zeldi..."
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                                rows="4"
                                className="bg-slate-950/50 border border-white/10 rounded-lg px-3 py-3 text-sm text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all resize-none placeholder:text-slate-500 leading-relaxed"
                            ></textarea>

                            <div className="flex justify-end">
                                <button 
                                    onClick={handlePost}
                                    disabled={isPosting}
                                    className="bg-indigo-600 hover:bg-indigo-500 disabled:bg-indigo-800 text-white text-xs font-bold px-6 py-3 rounded-lg transition-colors flex items-center gap-2"
                                >
                                    {isPosting ? (
                                        <span className="animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"></span>
                                    ) : 'Yorum Yap'}
                                </button>
                            </div>
                        </div>

                        <div className="space-y-3 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                            {isLoading ? (
                                <div className="text-center py-6 text-slate-500 text-sm animate-pulse">Yorumlar yÃ¼kleniyor...</div>
                            ) : comments.length === 0 ? (
                                <div className="text-center py-6 text-slate-500 text-sm">
                                    HenÃ¼z yorum yapÄ±lmamÄ±ÅŸ. Ä°lk sen yorum yap!
                                </div>
                            ) : (
                                comments.map((c) => (
                                    <div key={c.id} className="bg-slate-950/30 border border-white/5 p-3 rounded-lg animate-slide-in-right">
                                        <div className="flex justify-between items-start mb-1">
                                            <span className="text-xs font-bold text-indigo-300">{c.nickname}</span>
                                            <span className="text-[10px] text-slate-600">{formatDate(c.displayDate)}</span>
                                        </div>
                                        <p className="text-sm text-slate-300 leading-relaxed">
                                            {linkifyTimestamps(c.text, onSeek)}
                                        </p>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- UI Components ---
        const Navbar = ({ categories, activeCategory, setActiveCategory, lastUpdate }) => (
            <div className="border-b border-white/10 glass-panel sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex flex-col md:flex-row items-center justify-between gap-4 py-4 md:py-0 md:h-20">
                        <div className="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                            <div className="flex flex-col">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                                        <span className="text-xl">ğŸ“¼</span>
                                    </div>
                                    <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
                                        Katman YayÄ±n GeÃ§miÅŸi ArÅŸiv
                                    </h1>
                                </div>
                                {lastUpdate && <div className="ml-[52px] text-[10px] sm:text-xs text-indigo-400 font-medium tracking-wide mt-0.5">Son GÃ¼ncelleme: {lastUpdate}</div>}
                            </div>
                        </div>
                        <div className="hidden md:flex items-center gap-2 flex-wrap justify-center md:justify-end">
                            {categories.map((cat) => (
                                <button key={cat.id} onClick={() => setActiveCategory(cat.id)} className={`px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 whitespace-nowrap ${activeCategory === cat.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/25' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>{cat.name}</button>
                            ))}
                        </div>
                        <div className="md:hidden flex gap-2 overflow-x-auto w-full pb-2 no-scrollbar">
                            {categories.map((cat) => (
                                <button key={cat.id} onClick={() => setActiveCategory(cat.id)} className={`px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-300 whitespace-nowrap flex-shrink-0 ${activeCategory === cat.id ? 'bg-indigo-600 text-white' : 'text-slate-400 bg-slate-800/50'}`}>{cat.name}</button>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- DÃœZELTÄ°LMÄ°Å VÄ°DEO OYNATICI ---
        const VideoPlayer = ({ video, startTime, reloadKey }) => {
            if (!video) return (
                <div className="w-full aspect-video bg-slate-900/50 rounded-2xl border border-white/5 flex flex-col items-center justify-center text-center p-8 relative overflow-hidden group">
                     <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTAsMC4wNSkiLz48L3N2Zz4=')] [mask-image:linear-gradient(to_bottom,white,transparent)] opacity-30"></div>
                    <div className="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300 shadow-xl">
                        <span className="text-3xl">â–¶</span>
                    </div>
                    <h3 className="text-xl font-semibold text-white mb-2">Videonun AdÄ± Burada</h3>
                    <p className="text-slate-400 max-w-sm mx-auto mb-4">
                        Arama kutusuna bir kelime yazÄ±n veya listeden bir yayÄ±n seÃ§erek baÅŸlayÄ±n.
                    </p>
                    <div className="bg-indigo-500/10 border border-indigo-500/20 rounded-lg px-4 py-2 text-xs text-indigo-300">
                        ğŸ’¡ Sitedeki yayÄ±nlarÄ±n altyazÄ±larÄ± taranarak, aradÄ±ÄŸÄ±nÄ±z kelime geÃ§tiÄŸi anda video otomatik baÅŸlar.
                    </div>
                </div>
            );

            const baseUrl = `https://rumble.com/embed/${video.embedId}/?pub=4o7uxk`;
            
            let finalUrl = baseUrl;
            
            if (startTime) {
                const safeStart = Number(startTime);
                finalUrl = `${baseUrl}&start=${safeStart}&autoplay=1`;
            } else {
                finalUrl = `${baseUrl}&autoplay=1`;
            }

            return (
                <div className="w-full aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl shadow-indigo-900/20 border border-white/10 relative animate-fade-in ring-1 ring-indigo-500/20">
                    <iframe 
                        key={reloadKey} // KRÄ°TÄ°K: React'Ä±n iframe'i tamamen yeniden oluÅŸturmasÄ±nÄ± saÄŸlar
                        src={finalUrl} 
                        className="w-full h-full" 
                        allow="autoplay; fullscreen; picture-in-picture"
                        allowFullScreen
                        muted // KRÄ°TÄ°K: TarayÄ±cÄ±larÄ±n otomatik oynatma politikasÄ±nÄ± aÅŸar (sessiz baÅŸlar)
                        title={video.title}
                    ></iframe>
                </div>
            );
        };

        const NormalVideoCard = ({ video, isActive, onClick }) => {
            return (
                <div 
                    onClick={onClick} 
                    className={`group cursor-pointer rounded-xl overflow-hidden border transition-all animate-fade-in
                        ${isActive ? 'border-indigo-500 ring-1 ring-indigo-500/30' : 'border-white/5 hover:border-white/10 hover:shadow-lg hover:shadow-indigo-900/10'}
                    `}
                >
                    <div className="relative w-full aspect-[16/10] bg-black">
                        <iframe 
                            src={`https://rumble.com/embed/${video.embedId}/?pub=4o7uxk`} 
                            className="absolute inset-0 w-full h-full pointer-events-none" 
                            loading="lazy" 
                            allowFullScreen 
                            title={video.title}
                        ></iframe>
                        {isActive && <div className="absolute inset-0 bg-indigo-500/10 z-10 ring-2 ring-inset ring-indigo-500 pointer-events-none"></div>}
                    </div>
                    <div className="p-2 bg-slate-900/70 backdrop-blur-sm border-t border-white/5">
                        <p className="text-[11px] text-slate-300 line-clamp-2 leading-relaxed group-hover:text-white">{video.title}</p>
                        <div className="mt-1.5 flex items-center justify-between">
                            <span className="text-[9px] text-indigo-400 font-medium bg-indigo-500/10 px-1.5 py-0.5 rounded">{video.category}</span>
                            <span className="text-[9px] text-slate-500">{video.date.toLocaleDateString('tr-TR')}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const SearchResultItem = ({ item, onClick }) => {
            if (item.type === 'video') {
                return (
                    <div 
                        onClick={onClick} 
                        className={`group cursor-pointer rounded-xl overflow-hidden border transition-all animate-fade-in
                            ${item.isActive ? 'border-indigo-500 ring-1 ring-indigo-500/30' : 'border-white/5 hover:border-white/10 hover:shadow-lg hover:shadow-indigo-900/10'}
                        `}
                    >
                        <div className="relative w-full aspect-[16/10] bg-black">
                            <iframe 
                                src={`https://rumble.com/embed/${item.video.embedId}/?pub=4o7uxk`} 
                                className="absolute inset-0 w-full h-full pointer-events-none" 
                                loading="lazy" 
                                allowFullScreen
                            ></iframe>
                            {item.isActive && <div className="absolute inset-0 bg-indigo-500/20 z-10 ring-2 ring-inset ring-indigo-500 pointer-events-none"></div>}
                        </div>
                        <div className="p-2 bg-slate-900/70 backdrop-blur-sm border-t border-white/5">
                            <p className="text-[11px] text-slate-300 line-clamp-2 leading-relaxed group-hover:text-white">{item.video.title}</p>
                        </div>
                    </div>
                );
            } else if (item.type === 'timestamp') {
                const contentHtml = `<span class="text-indigo-400 font-mono mr-1">[${item.timestamp}]</span>` + 
                    item.snippet.replace(new RegExp(`(${item.searchTerm})`, 'gi'), '<mark class="bg-indigo-500/40 text-white px-0.5 rounded">$1</mark>');

                return (
                    <div 
                        onClick={onClick} 
                        className="group cursor-pointer rounded-xl overflow-hidden border border-indigo-500/30 bg-slate-900/80 backdrop-blur hover:bg-indigo-900/20 hover:border-indigo-500 transition-all p-2 relative animate-fade-in"
                    >
                        <div className="flex items-start gap-2">
                            <div className="flex-shrink-0 w-10 h-10 rounded bg-indigo-600/20 flex flex-col items-center justify-center text-indigo-400 border border-indigo-500/20 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                <span className="text-[9px] font-bold leading-none mb-0.5">ATLA</span>
                                <span className="text-[9px] font-mono">{item.timestamp}</span>
                            </div>
                            <div className="flex-1 min-w-0">
                                <p 
                                    className="text-[11px] text-slate-300 leading-snug group-hover:text-white whitespace-pre-wrap"
                                    dangerouslySetInnerHTML={{ __html: contentHtml }}
                                ></p>
                                <p className="text-[9px] text-slate-500 mt-1 uppercase truncate">{item.video.title}</p>
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const NormalVideoList = ({ videos, selectedVideoId, onSelect }) => {
            if (videos.length === 0) {
                return <div className="text-center py-12 text-slate-500 bg-slate-900/30 rounded-xl border border-dashed border-white/5">Bu kategoride video bulunamadÄ±.</div>;
            }
            return (
                <>
                    {videos.map((video) => (
                        <NormalVideoCard
                            key={`normal-${video.id}`}
                            video={video}
                            isActive={selectedVideoId === video.id}
                            onClick={() => onSelect(video)}
                        />
                    ))}
                </>
            );
        };

        const SearchResultsList = ({ results, selectedVideoId, onSelect, searchTerm, categoryName }) => {
            if (results.length === 0) {
                return (
                    <div className="text-center py-10 px-4 bg-slate-900/30 rounded-xl border border-dashed border-white/5 animate-fade-in">
                        <div className="text-4xl mb-2">ğŸ”</div>
                        <p className="text-slate-400 text-sm font-medium">"{searchTerm}" iÃ§in sonuÃ§ bulunamadÄ±.</p>
                        <p className="text-slate-600 text-xs mt-2">
                            {categoryName === 'TÃ¼m ArÅŸiv' 
                                ? 'AradÄ±ÄŸÄ±nÄ±z kelime yayÄ±nlarda geÃ§memiÅŸ olabilir.' 
                                : 'Sadece seÃ§ili kategori ('+categoryName+') iÃ§inde aranÄ±yor. Filtreyi "TÃ¼m ArÅŸiv" yapÄ±p tekrar deneyin.'
                            }
                        </p>
                    </div>
                );
            }
            return (
                <>
                    {results.map((item, index) => (
                        <SearchResultItem
                            key={`search-${item.id || index}`}
                            item={{
                                ...item,
                                isActive: item.type === 'video' ? selectedVideoId === item.video.id : false
                            }}
                            onClick={() => onSelect(item.video, item.seconds || null)}
                        />
                    ))}
                </>
            );
        };

        const HelperInfo = () => (
            <div className="bg-indigo-500/5 border border-indigo-500/10 rounded-xl p-3 mb-2 animate-fade-in">
                <h4 className="text-indigo-400 text-[10px] font-bold uppercase tracking-wider mb-1.5 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
                    NasÄ±l KullanÄ±lÄ±r?
                </h4>
                <ul className="text-[10px] text-slate-300 space-y-1 list-disc list-inside leading-relaxed">
                    <li><strong className="text-white">Arama:</strong> Bir kelime yazÄ±n. Sistem altyazÄ±larÄ± tarayÄ±p o kelimenin geÃ§tiÄŸi saati (timestamp) bulur.</li>
                    <li><strong className="text-white">Oynat:</strong> Arama sonucuna tÄ±klayÄ±n, video otomatik o noktadan baÅŸlar.</li>
                    <li><strong className="text-white">Filtrele:</strong> YukarÄ±daki kategorilerden seÃ§im yaparak sadece o yayÄ±ncÄ±yÄ± listeleyin.</li>
                </ul>
            </div>
        );

        const App = () => {
            const [videos, setVideos] = useState([]);
            const [lastUpdate, setLastUpdate] = useState("");
            const [loading, setLoading] = useState(true);
            const [selectedVideo, setSelectedVideo] = useState(null);
            const [startTime, setStartTime] = useState(null); 
            const [reloadKey, setReloadKey] = useState(0); 
            const [activeCategory, setActiveCategory] = useState('all');
            const [searchTerm, setSearchTerm] = useState("");
            const [searchResults, setSearchResults] = useState([]); 
            const [isSearchingText, setIsSearchingText] = useState(false);
            const textCache = useRef({}); 
            const debounceTimerRef = useRef(null);
            const searchIdRef = useRef(0);

            const isSearchActive = cleanSearch(searchTerm).length > 0;

            const handleSeekComment = (seconds) => {
                setStartTime(seconds);
                setReloadKey(prev => prev + 1); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleSelectVideo = (video, startSeconds = null) => {
                setSelectedVideo(video);
                setStartTime(startSeconds);
                setReloadKey(prev => prev + 1);

                if (window.innerWidth < 1024) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            useEffect(() => {
                const fetchVideos = async () => {
                    try {
                        const response = await fetch(`videos.json?t=${new Date().getTime()}`);
                        if (!response.ok) throw new Error("Dosya bulunamadÄ±");
                        const data = await response.json();
                        const rawVideos = Array.isArray(data) ? data : (data.videos || []);
                        const tarih = Array.isArray(data) ? "" : (data.tarih || "");
                        setLastUpdate(tarih);
                        const processed = processVideoData(rawVideos);
                        setVideos(processed);
                    } catch (error) {
                        console.warn("videos.json yÃ¼klenemedi, yedek veri kullanÄ±lÄ±yor.", error);
                        const processed = processVideoData(FALLBACK_DATA.videos);
                        setLastUpdate(FALLBACK_DATA.tarih);
                        setVideos(processed);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchVideos();
            }, []);

            useEffect(() => {
                if (!isSearchActive) {
                    setSearchResults([]); 
                    setIsSearchingText(false);
                    searchIdRef.current++;
                    if (debounceTimerRef.current) clearTimeout(debounceTimerRef.current);
                }
            }, [isSearchActive]);

            useEffect(() => {
                const term = cleanSearch(searchTerm).toLowerCase();
                if (!term) return;
                
                if (debounceTimerRef.current) clearTimeout(debounceTimerRef.current);

                const performSearch = async () => {
                    const currentSearchId = ++searchIdRef.current;
                    
                    setSearchResults([]);
                    setIsSearchingText(true);

                    if (videos.length === 0) return;

                    const videosToSearch = videos.filter(v => 
                        activeCategory === 'all' || normalizeText(v.category) === normalizeText(activeCategory)
                    );

                    const titleMatches = videosToSearch.filter(v => {
                        const textMatch = normalizeText(v.title).includes(term);
                        return textMatch;
                    });

                    let results = titleMatches.map(v => ({
                        type: 'video',
                        video: v,
                        id: `video-${v.id}`,
                        isActive: false
                    }));

                    const fetchPromises = videosToSearch.map(async (v) => {
                        if (normalizeText(v.title).includes(term)) return []; 

                        const path = getTxtPath(v.title); 
                        
                        let content = textCache.current[path];
                        if (!content) {
                            try {
                                let res = await fetch(path);
                                if (!res.ok) {
                                    const lowerPath = path.toLowerCase(); 
                                    res = await fetch(lowerPath);
                                    if (!res.ok) return []; 
                                    
                                    content = await res.text();
                                    textCache.current[lowerPath] = content;
                                } else {
                                    content = await res.text();
                                    textCache.current[path] = content; 
                                }
                            } catch (e) {
                                return []; 
                            }
                        }

                        const lines = content.split('\n');
                        const hits = [];
                        lines.forEach(line => {
                            if (line.toLowerCase().includes(term)) {
                                const timeMatch = line.match(/\[(\d{2}):(\d{2}):(\d{2})\]/);
                                if (timeMatch) {
                                    const h = parseInt(timeMatch[1]);
                                    const m = parseInt(timeMatch[2]);
                                    const s = parseInt(timeMatch[3]);
                                    const totalSeconds = h * 3600 + m * 60 + s;
                                    
                                    let snippet = line.replace(timeMatch[0], '').trim(); 
                                    
                                    hits.push({
                                        type: 'timestamp',
                                        video: v,
                                        timestamp: `${h}:${m}:${s}`,
                                        seconds: totalSeconds,
                                        snippet: snippet,
                                        id: `ts-${v.id}-${totalSeconds}`,
                                        searchTerm: term
                                    });
                                }
                            }
                        });
                        return hits;
                    });

                    const textHitsArrays = await Promise.all(fetchPromises);
                    const allTextHits = textHitsArrays.flat();

                    if (currentSearchId !== searchIdRef.current) return; 

                    setSearchResults([...allTextHits, ...results]);
                    setIsSearchingText(false);
                };

                debounceTimerRef.current = setTimeout(() => {
                    performSearch();
                }, 500);

            }, [searchTerm, videos, activeCategory]); 

            const displayVideos = useMemo(() => {
                if (activeCategory === 'all') return videos;
                return videos.filter(video => normalizeText(video.category) === normalizeText(activeCategory));
            }, [activeCategory, videos]);

            return (
                <div className="min-h-screen flex flex-col pb-24">
                    <Navbar categories={CATEGORIES} activeCategory={activeCategory} setActiveCategory={setActiveCategory} lastUpdate={lastUpdate} />

                    <main className="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            <div className="lg:col-span-8 space-y-6">
                                <div className="animate-slide-up">
                                    <VideoPlayer video={selectedVideo} startTime={startTime} reloadKey={reloadKey} />
                                    
                                    {!selectedVideo && <CommentGuideBox />}

                                    {selectedVideo && (
                                        <div className="mt-6 p-6 rounded-2xl bg-slate-900/40 border border-white/5 flex items-start gap-4 animate-fade-in">
                                            <div className="p-3 rounded-xl bg-indigo-500/10 text-indigo-400">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m7 15 5-5 5 5"/></svg>
                                            </div>
                                            <div>
                                                <h2 className="text-xl font-bold text-white mb-1">{selectedVideo.title}</h2>
                                                <p className="text-slate-400 text-sm">
                                                    OynatÄ±lÄ±yor â€¢ {selectedVideo.category} 
                                                    {startTime && ` â€¢ Zaman: ${Math.floor(startTime/3600)}:${Math.floor((startTime%3600)/60)}:${startTime%60}`}
                                                </p>
                                            </div>
                                        </div>
                                    )}

                                    {selectedVideo && selectedVideo.embedId && (
                                        <CommentSection 
                                            videoId={selectedVideo.embedId} 
                                            onSeek={handleSeekComment} 
                                        />
                                    )}
                                </div>
                            </div>

                            <div className="lg:col-span-4 space-y-3 animate-slide-up" style={{animationDelay: '100ms'}}>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <svg className="h-5 w-5 text-slate-500 group-focus-within:text-indigo-500 transition-colors" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                    </div>
                                    <input
                                        type="text"
                                        placeholder="Kelime, sÃ¶z veya cÃ¼mle arayÄ±n..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(cleanSearch(e.target.value))}
                                        className="w-full bg-slate-900/50 border border-white/10 text-slate-100 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 block w-full pl-11 p-3 transition-all duration-300 placeholder:text-slate-600"
                                    />
                                </div>

                                {!isSearchActive && <HelperInfo />}

                                <div className="flex items-center justify-between px-2 sticky top-0 bg-[#020617] z-10 py-1 mb-1">
                                    <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                        {isSearchingText ? 'ğŸ“ Metinler taranÄ±yor...' : (isSearchActive ? (
                                            <span className="text-[11px]">
                                                <span className="text-white font-normal">'{searchTerm}'</span>
                                                <span className="text-slate-500 mx-1">â€¢</span>
                                                <span className="text-indigo-400 text-[10px] bg-indigo-500/10 px-2 py-0.5 rounded border border-indigo-500/20">
                                                    {getCategoryName(activeCategory)}
                                                </span>
                                            </span>
                                        ) : `${displayVideos.length} Video`)}
                                    </h3>
                                </div>

                                <div 
                                    key={isSearchActive ? 'search-mode' : 'normal-mode'} 
                                    className="space-y-2 overflow-y-auto h-[600px] pr-2 pb-4"
                                >
                                    {loading ? (
                                        <div className="text-center py-8 text-slate-500 animate-pulse">Videolar yÃ¼kleniyor...</div>
                                    ) : isSearchActive ? (
                                        <SearchResultsList
                                            results={searchResults}
                                            selectedVideoId={selectedVideo?.id}
                                            searchTerm={searchTerm}
                                            categoryName={getCategoryName(activeCategory)}
                                            onSelect={handleSelectVideo}
                                        />
                                    ) : (
                                        <NormalVideoList
                                            videos={displayVideos}
                                            selectedVideoId={selectedVideo?.id}
                                            onSelect={handleSelectVideo}
                                        />
                                    )}
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    <footer className="border-t border-white/5 mt-12 py-8 bg-black/20 backdrop-blur-sm text-center">
                        <p className="text-slate-600 text-sm">Â© 2025 Katman YayÄ±n GeÃ§miÅŸi ArÅŸiv.</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
