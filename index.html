<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Katman Yayƒ±n Ge√ßmi≈üi Ar≈üiv</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React ve ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK (Compat versiyonu) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            950: '#020617',
                            900: '#0f172a',
                            800: '#1e293b',
                        },
                        brand: {
                            400: '#818cf8', // Indigo
                            500: '#6366f1',
                            600: '#4f46e5',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'crossfade': 'crossfade 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideInRight: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        crossfade: { '0%': { opacity: '0.5' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Mobile Bottom Nav Safe Area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

        .aurora-glow {
            position: absolute; width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(99,102,241,0.15) 0%, rgba(0,0,0,0) 70%);
            border-radius: 50%; filter: blur(80px); z-index: -1;
            animation: aurora 15s infinite alternate; pointer-events: none;
        }
        @keyframes aurora {
            0% { transform: translate(-20%, -20%) scale(1); opacity: 0.5; }
            100% { transform: translate(-10%, 20%) scale(0.9); opacity: 0.5; }
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Input Range Styling for Seek */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: #6366f1;
            margin-top: -6px;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            background: #334155;
            border-radius: 2px;
        }
    </style>
</head>
<body class="text-slate-100 antialiased overflow-x-hidden min-h-screen flex flex-col selection:bg-brand-500 selection:text-white">
    
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="aurora-glow top-[-200px] left-[-200px] bg-indigo-500/20"></div>
        <div class="aurora-glow bottom-[-200px] right-[-200px] bg-purple-500/10 delay-1000"></div>
    </div>

    <a 
        href="https://www.instagram.com/tinitavolkan/" 
        target="_blank" 
        rel="noopener noreferrer"
        class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 flex items-center gap-3 px-8 py-3.5 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white transition-all duration-300 shadow-xl shadow-purple-600/40 hover:scale-105 animate-slide-up border border-white/10 group md:hidden"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="group-hover:rotate-6 transition-transform">
            <rect width="20" height="20" x="2" y="2" rx="5" ry="5" />
            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" />
            <line x1="17.5" x2="17.51" y1="6.5" y2="6.5" />
        </svg>
        <span class="text-sm font-bold tracking-wide">Instagram</span>
    </a>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- FIREBASE KURULUMU ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVhRw5lEIrJ5cFjJS1D86AvJeAI67ja0Q",
            authDomain: "site-comments-ed18f.firebaseapp.com",
            projectId: "site-comments-ed18f",
            storageBucket: "site-comments-ed18f.firebasestorage.app",
            messagingSenderId: "587969670836",
            appId: "1:587969670836:web:de8f614bbcafa0ed2b1e1"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();

        db.settings({
          experimentalForceLongPolling: true,
          useFetchStreams: false
        });

        const CATEGORIES = [
            { id: 'all', name: 'T√ºm Ar≈üiv' },
            { id: 'Hype', name: 'Hype' },
            { id: 'Triel', name: 'Triel' },
            { id: 'Sinasi', name: '≈ûinasi' }, 
            { id: 'Prensesperver', name: 'Prensesperver' },
            { id: 'Nuriben', name: 'Nuriben' },
            { id: 'Nesrin', name: 'Nesrin' },
            { id: 'Egearseven', name: 'Egearseven' },
            { id: 'Blush', name: 'Blush' }
        ];

        const FALLBACK_DATA = {
            "tarih": "02.01.2026",
            "videos": [
                { "title": "Blush 15.12.2025 1", "embed_id": "v71l1b4", "link": "https://rumble.com/v71l1b4-blush.html" }, 
                { "title": "Blush 15.12.2025 2_Parca_000", "embed_id": "v71l1b5", "link": "https://rumble.com/v71l1b5-blush.html" }
            ]
        };

        // --- Utility Functions ---
        const cleanSearch = (val) => (val || '').replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/\u00A0/g, ' ').trim();
        const normalizeText = (str) => {
            return str.toString().toLowerCase()
                .replace('ƒü', 'g').replace('√º', 'u').replace('≈ü', 's')
                .replace('ƒ±', 'i').replace('√∂', 'o').replace('√ß', 'c');
        };

        const processVideoData = (rawVideos) => {
            const getSortParts = (title) => {
                const match = title.match(/(\d+)\s*_Parca_\s*(\d+)/);
                if (match) return { mainPart: parseInt(match[1], 10), subPart: parseInt(match[2], 10) };
                return { mainPart: 0, subPart: 0 };
            };

            const processed = rawVideos.map((v, index) => {
                const dateMatch = v.title.match(/(\d{2})\.(\d{2})\.(\d{4})/);
                const date = dateMatch ? new Date(dateMatch[3], dateMatch[2] - 1, dateMatch[1]) : new Date();
                const normalizedTitle = normalizeText(v.title);
                let category = "Diƒüer";
                for (let cat of CATEGORIES) {
                    if (cat.id === 'all') continue;
                    const normalizedCat = normalizeText(cat.id);
                    if (normalizedTitle.includes(normalizedCat)) {
                        category = cat.name;
                        break;
                    }
                }
                return {
                    id: v.embed_id || index, 
                    title: v.title,
                    embedId: v.embed_id, 
                    date: date,
                    category: category,
                    sortMetrics: getSortParts(v.title)
                };
            });

            processed.sort((a, b) => {
                const dateDiff = b.date - a.date;
                if (dateDiff !== 0) return dateDiff;
                if (a.sortMetrics.mainPart !== b.sortMetrics.mainPart) return a.sortMetrics.mainPart - b.sortMetrics.mainPart;
                return a.sortMetrics.subPart - b.sortMetrics.subPart;
            });
            return processed;
        };

        const getTxtPath = (title) => {
            let cleanTitle = title.replace(/\.html$/, '');
            let filename = cleanTitle + ".txt";
            return `text/${filename}`;
        };

        const getCategoryName = (id) => {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.name : id;
        };

        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        // --- METƒ∞N ƒ∞≈ûLEME ---
        const linkifyTimestamps = (text, onSeek) => {
            if (!text) return text;
            const timeRegex = /(\d{1,2}):(\d{2})(?::(\d{2}))?/g;
            const parts = [];
            let lastIndex = 0;
            let match;

            while ((match = timeRegex.exec(text)) !== null) {
                if (match.index > lastIndex) parts.push(text.substring(lastIndex, match.index));
                const [fullMatch, h, m, s] = match;
                let seconds = s !== undefined ? parseInt(h)*3600 + parseInt(m)*60 + parseInt(s) : parseInt(h)*60 + parseInt(m);
                
                parts.push(
                    <span key={`time-${match.index}`} onClick={() => onSeek(seconds)} className="text-indigo-400 cursor-pointer hover:text-indigo-300 hover:bg-indigo-500/10 px-1 rounded transition-colors font-mono text-xs" title="Videonun bu anƒ±na git">
                        {fullMatch}
                    </span>
                );
                lastIndex = timeRegex.lastIndex;
            }
            if (lastIndex < text.length) parts.push(text.substring(lastIndex));
            return parts.length === 0 ? text : parts;
        };

        // --- MOBILE NAV COMPONENT ---
        const MobileNav = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'video', icon: 'üé¨', label: 'Video' },
                { id: 'search', icon: 'üîç', label: 'Ara' },
                { id: 'comments', icon: 'üí¨', label: 'Yorumlar' }
            ];

            return (
                <div className="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-md border-t border-white/10 z-40 pb-safe">
                    <div className="flex justify-around items-center h-16">
                        {tabs.map((tab) => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex flex-col items-center justify-center w-full h-full transition-all duration-300 ${activeTab === tab.id ? 'text-indigo-400' : 'text-slate-500'}`}
                            >
                                <span className="text-xl mb-1">{tab.icon}</span>
                                <span className="text-[10px] font-medium">{tab.label}</span>
                                {activeTab === tab.id && <div className="absolute top-0 w-full h-0.5 bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.8)]"></div>}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- YORUM REHBERƒ∞ ---
        const CommentGuideBox = () => (
            <div className="rounded-2xl bg-gradient-to-br from-indigo-900/30 to-slate-900/40 border border-indigo-500/20 overflow-hidden animate-fade-in mt-6">
                <div className="p-6">
                    <div className="flex items-center gap-3 mb-4">
                        <div className="p-2 bg-indigo-500/20 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </div>
                        <h3 className="text-xl font-bold text-white">Nasƒ±l Kullanƒ±lƒ±r?</h3>
                    </div>
                    <div className="space-y-3 text-sm text-slate-300">
                        <p>üîç <strong className="text-white">Arama:</strong> Kelime yaz, altyazƒ±larƒ± tarayayƒ±m.</p>
                        <p>‚è±Ô∏è <strong className="text-white">Linkle:</strong> Yorumlarda <span className="font-mono bg-indigo-500/20 px-1 rounded text-xs">12:30</span> yaz, tƒ±klayƒ±nca oraya gitsin.</p>
                        <p>üíæ <strong className="text-white">Kaydet:</strong> Payla≈üƒ±m linki ≈üu an aktif durumu kapsar.</p>
                    </div>
                </div>
            </div>
        );

        // --- FIREBASE YORUM Bƒ∞LE≈ûENƒ∞ ---
        const CommentSection = ({ videoId, onSeek }) => {
            const [comments, setComments] = useState([]);
            const [nickname, setNickname] = useState('');
            const [text, setText] = useState('');
            const [isPosting, setIsPosting] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isEditingNick, setIsEditingNick] = useState(false);
            const [localNick, setLocalNick] = useState('');

            useEffect(() => {
                const savedNick = localStorage.getItem('katman_user_nickname');
                if (savedNick) {
                    setNickname(savedNick);
                    setLocalNick(savedNick);
                }
            }, []);

            const handleSaveNick = () => {
                const newNick = localNick.trim();
                if(newNick) {
                    setNickname(newNick);
                    localStorage.setItem('katman_user_nickname', newNick);
                    setIsEditingNick(false);
                }
            };

            useEffect(() => {
                if (!videoId) return;
                setIsLoading(true);
                const q = db.collection("comments").where("videoId", "==", videoId).orderBy("createdAt", "asc");
                const unsubscribe = q.onSnapshot((snapshot) => {
                    const fetchedComments = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data.createdAt ? data.createdAt.toDate() : new Date();
                        fetchedComments.push({ id: doc.id, ...data, displayDate: date });
                    });
                    setComments(fetchedComments);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Yorum Hatasƒ±:", error);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [videoId]);

            const handlePost = async () => {
                if (!nickname.trim()) { alert("L√ºtfen takma ad belirleyin."); return; }
                if (!text.trim()) { alert("Yorum bo≈ü olamaz."); return; }
                if (text.length > 500) { alert("Yorum √ßok uzun (Max 500 karakter)."); return; }
                
                setIsPosting(true);
                try {
                    await db.collection("comments").add({
                        videoId, 
                        nickname: nickname.trim(),
                        text: text.trim(),
                        likes: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setText('');
                } catch (error) {
                    alert("Hata: " + error.message);
                } finally {
                    setIsPosting(false);
                }
            };

            const handleLike = async (commentId, currentLikes) => {
                try {
                    await db.collection("comments").doc(commentId).update({
                        likes: firebase.firestore.FieldValue.increment(1)
                    });
                } catch (e) { console.error(e); }
            };

            const formatDate = (dateObj) => new Intl.DateTimeFormat('tr-TR', { day: '2-digit', month: 'long', hour: '2-digit', minute:'2-digit' }).format(dateObj);

            if (!videoId) return null;

            return (
                <div className="mt-6 rounded-2xl bg-slate-900/40 border border-white/5 overflow-hidden animate-slide-up">
                    <div className="p-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                        <h3 className="font-bold text-white flex items-center gap-2">
                            <span className="text-indigo-400">üí¨</span> Yorumlar <span className="text-xs font-normal text-slate-400 ml-1">({comments.length})</span>
                        </h3>
                    </div>

                    <div className="p-4 space-y-4">
                        {/* Nickname Section */}
                        <div className="bg-slate-950/50 p-3 rounded-lg border border-white/5 flex items-center justify-between">
                            {isEditingNick ? (
                                <div className="flex gap-2 w-full">
                                    <input value={localNick} onChange={(e) => setLocalNick(e.target.value)} className="bg-slate-800 text-white text-sm px-2 py-1 rounded w-full outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Takma Ad" maxLength="15" />
                                    <button onClick={handleSaveNick} className="bg-indigo-600 text-white text-xs px-3 py-1 rounded hover:bg-indigo-500">Kaydet</button>
                                </div>
                            ) : (
                                <div className="flex items-center gap-2 w-full">
                                    <span className="text-xs text-slate-400">G√∂r√ºnen Ad:</span>
                                    <span className="text-sm font-bold text-indigo-300">{nickname || 'Misafir'}</span>
                                    <button onClick={() => setIsEditingNick(true)} className="text-[10px] text-slate-500 hover:text-white underline ml-auto">Deƒüi≈ütir</button>
                                </div>
                            )}
                        </div>

                        <textarea 
                            placeholder="Videonun bu anƒ± hakkƒ±nda ne d√º≈ü√ºn√ºyorsun? √ñrn: 12:30'daki sahne √ßok g√ºzeldi..."
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                            rows="3"
                            maxLength="500"
                            className="w-full bg-slate-950/50 border border-white/10 rounded-lg px-3 py-3 text-sm text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none resize-none placeholder:text-slate-500 leading-relaxed"
                        ></textarea>
                        <div className="flex justify-between items-center">
                            <span className="text-[10px] text-slate-600">{text.length}/500</span>
                            <button onClick={handlePost} disabled={isPosting} className="bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-800 text-white text-xs font-bold px-6 py-2 rounded-lg transition-colors">
                                {isPosting ? 'G√∂nderiliyor...' : 'Yorum Yap'}
                            </button>
                        </div>

                        {/* Comments List */}
                        <div className="space-y-3 max-h-[400px] overflow-y-auto pr-1">
                            {isLoading ? (
                                <div className="text-center py-6 text-slate-500 text-sm animate-pulse">Yorumlar y√ºkleniyor...</div>
                            ) : comments.length === 0 ? (
                                <div className="text-center py-8 text-slate-500 text-sm bg-slate-950/30 rounded-lg border border-dashed border-white/5">
                                    ƒ∞lk yorumu sen yap!
                                </div>
                            ) : (
                                comments.map((c) => (
                                    <div key={c.id} className="bg-slate-950/30 border border-white/5 p-3 rounded-lg hover:border-white/10 transition-colors">
                                        <div className="flex justify-between items-start mb-1">
                                            <span className="text-xs font-bold text-indigo-300">{c.nickname}</span>
                                            <span className="text-[10px] text-slate-600">{formatDate(c.displayDate)}</span>
                                        </div>
                                        <p className="text-sm text-slate-300 leading-relaxed mb-2">{linkifyTimestamps(c.text, onSeek)}</p>
                                        <div className="flex items-center gap-3">
                                            <button onClick={() => handleLike(c.id, c.likes)} className="flex items-center gap-1 text-[10px] text-slate-500 hover:text-pink-500 transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10v12"/><path d="M15 10v12"/><path d="M6 14h12"/><path d="M6 10l2.5-5h7L18 10"/></svg>
                                                {c.likes > 0 && <span>{c.likes}</span>}
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- VIDEO PLAYER COMPONENT ---
        const VideoPlayer = ({ video, startTime, reloadKey }) => {
            if (!video) return (
                <div className="w-full aspect-video bg-slate-900/50 rounded-2xl border border-white/5 flex flex-col items-center justify-center text-center p-8 relative overflow-hidden group">
                    <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTAsMC4wNSkiLz48L3N2Zz4=')] opacity-30"></div>
                    <div className="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                        <span className="text-3xl">‚ñ∂</span>
                    </div>
                    <h3 className="text-xl font-semibold text-white mb-2">Bir Video Se√ßin</h3>
                    <p className="text-slate-400 text-sm max-w-sm">Listeden bir yayƒ±n se√ßin veya arama yapƒ±n.</p>
                </div>
            );

            const baseUrl = `https://rumble.com/embed/${video.embedId}/?pub=4o7uxk`;
            let finalUrl = baseUrl;
            
            // Zaman damgasƒ± varsa ekle
            if (startTime) {
                const safeStart = Number(startTime);
                finalUrl = `${baseUrl}&start=${safeStart}&autoplay=1&cb=${reloadKey}`;
            } else {
                finalUrl = `${baseUrl}&autoplay=1&cb=${reloadKey}`;
            }

            return (
                <div className={`w-full aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl shadow-indigo-900/20 border border-white/10 relative animate-crossfade ring-1 ring-indigo-500/20 ${video ? 'animate-pulse-slow' : ''}`}>
                    <iframe 
                        key={`${video.id}-${reloadKey}`} // Force remount on reloadKey
                        src={finalUrl} 
                        className="w-full h-full" 
                        allowFullScreen 
                        title={video.title}
                    ></iframe>
                    {startTime && (
                        <div className="absolute top-4 right-4 bg-red-600/90 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg backdrop-blur animate-fade-in">
                            ‚è± {formatTime(startTime)}
                        </div>
                    )}
                </div>
            );
        };

        // --- THUMBNAIL CARD COMPONENT (Lazy Loading Wrapper) ---
        const ThumbnailCard = ({ video, isActive, onClick }) => {
            const [thumbnail, setThumbnail] = useState(null);
            const [isVisible, setIsVisible] = useState(false);
            const cardRef = useRef(null);

            // Intersection Observer for "Lazy" loading attempt
            useEffect(() => {
                const observer = new IntersectionObserver(([entry]) => {
                    if (entry.isIntersecting) {
                        setIsVisible(true);
                        observer.disconnect();
                    }
                }, { rootMargin: '200px' });
                
                if (cardRef.current) observer.observe(cardRef.current);
                return () => observer.disconnect();
            }, []);

            // Fetch Thumbnail logic when visible
            useEffect(() => {
                if (!isVisible) return;
                // Rumble API endpoint attempt
                // Nota bene: Rumble API might block CORS or require keys. 
                // We use a fallback to generated gradient if it fails.
                fetch(`https://rumble.com/api/Media.Videoinfo?video=${video.embedId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.meta && data.meta.thumbnail) {
                            setThumbnail(data.meta.thumbnail);
                        }
                    })
                    .catch(() => {
                        // Fallback handled by rendering logic
                    });
            }, [isVisible, video.embedId]);

            // Fallback gradient based on category to make it look good even without image
            const gradientColors = {
                'Blush': 'from-pink-900 to-slate-900',
                'Hype': 'from-red-900 to-slate-900',
                'Triel': 'from-purple-900 to-slate-900',
                'Diƒüer': 'from-slate-800 to-slate-900'
            };
            const bgClass = gradientColors[video.category] || gradientColors['Diƒüer'];

            return (
                <div 
                    ref={cardRef}
                    onClick={onClick} 
                    className={`group cursor-pointer rounded-xl overflow-hidden border transition-all duration-300 animate-fade-in relative
                        ${isActive ? 'border-indigo-500 ring-1 ring-indigo-500/50 transform scale-[1.02] z-10' : 'border-white/5 hover:border-white/20 hover:bg-white/5'}
                    `}
                >
                    <div className={`relative w-full aspect-video ${bgClass} ${thumbnail ? 'bg-black' : ''}`}>
                        {thumbnail ? (
                            <img src={thumbnail} alt={video.title} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" loading="lazy" />
                        ) : (
                            <div className={`absolute inset-0 bg-gradient-to-br ${bgClass} flex items-center justify-center`}>
                                <span className="text-4xl opacity-20 group-hover:scale-110 transition-transform duration-500">‚ñ∂</span>
                            </div>
                        )}
                        
                        <div className="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors"></div>
                        
                        {/* Duration/Category Badge */}
                        <div className="absolute top-2 left-2 bg-black/60 backdrop-blur text-[10px] font-bold px-2 py-0.5 rounded text-white border border-white/10">
                            {video.category}
                        </div>
                    </div>

                    <div className="p-3 bg-slate-900/90 backdrop-blur-sm border-t border-white/5">
                        <p className="text-xs text-slate-200 font-medium line-clamp-2 leading-relaxed group-hover:text-white">{video.title}</p>
                        <div className="mt-2 flex items-center justify-between">
                            <span className="text-[10px] text-slate-500">{video.date.toLocaleDateString('tr-TR')}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- SEARCH RESULTS ITEM ---
        const SearchResultItem = ({ item, onClick }) => {
            if (item.type === 'video') {
                return <ThumbnailCard video={item.video} isActive={item.isActive} onClick={() => onClick(item.video)} />;
            } 
            
            // Timestamp Result
            const highlightRegex = new RegExp(`(${item.searchTerm})`, 'gi');
            const parts = item.snippet.split(highlightRegex);
            
            return (
                <div 
                    onClick={onClick} 
                    className="group cursor-pointer rounded-xl overflow-hidden border border-indigo-500/30 bg-slate-900/80 backdrop-blur hover:bg-indigo-900/20 hover:border-indigo-500 transition-all p-3 relative animate-fade-in mb-2"
                >
                    <div className="flex items-start gap-3">
                        <div className="flex-shrink-0 w-12 h-12 rounded-lg bg-indigo-600/20 flex flex-col items-center justify-center text-indigo-400 border border-indigo-500/20 group-hover:bg-indigo-600 group-hover:text-white transition-colors shadow-lg shadow-indigo-900/20">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                                <span className="text-xs font-bold text-white bg-indigo-500 px-1.5 py-0.5 rounded">{item.timestamp}</span>
                                <span className="text-[9px] text-slate-400 uppercase">Altyazƒ±da Bulundu</span>
                            </div>
                            <p className="text-xs text-slate-300 leading-snug mb-1">
                                {parts.map((part, i) => 
                                    part.toLowerCase() === item.searchTerm.toLowerCase() ? 
                                    <mark key={i} className="bg-indigo-500/50 text-white px-0.5 rounded">{part}</mark> : part
                                )}
                            </p>
                            <p className="text-[9px] text-slate-500 truncate">{item.video.title}</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NAVBAR ---
        const Navbar = ({ categories, activeCategory, setActiveCategory, lastUpdate, isMobile }) => (
            <div className="border-b border-white/10 glass-panel sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex flex-col md:flex-row items-center justify-between gap-4 py-4 md:py-0 md:h-20">
                        <div className="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                                    <span className="text-xl">üìº</span>
                                </div>
                                <div>
                                    <h1 className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400 leading-none">
                                        Katman Ar≈üiv
                                    </h1>
                                    {lastUpdate && <div className="text-[9px] text-indigo-400 font-medium tracking-wide mt-1">Son G√ºncelleme: {lastUpdate}</div>}
                                </div>
                            </div>
                        </div>
                        {/* Categories - Desktop only. Mobile uses Dropdown in Search or just scroll. */}
                        {!isMobile && (
                            <div className="flex items-center gap-2 flex-wrap justify-center md:justify-end">
                                {categories.map((cat) => (
                                    <button key={cat.id} onClick={() => setActiveCategory(cat.id)} className={`px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 whitespace-nowrap ${activeCategory === cat.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/25' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>{cat.name}</button>
                                ))}
                            </div>
                        )}
                        {/* Mobile Category Scroll - Very compact */}
                        {isMobile && (
                             <div className="flex gap-2 overflow-x-auto w-full pb-1 no-scrollbar mask-gradient">
                                {categories.map((cat) => (
                                    <button key={cat.id} onClick={() => setActiveCategory(cat.id)} className={`px-3 py-1 rounded-full text-[10px] font-medium transition-all duration-300 whitespace-nowrap flex-shrink-0 ${activeCategory === cat.id ? 'bg-indigo-600 text-white' : 'text-slate-400 bg-slate-800/50 border border-white/5'}`}>{cat.name}</button>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [videos, setVideos] = useState([]);
            const [lastUpdate, setLastUpdate] = useState("");
            const [loading, setLoading] = useState(true);
            const [selectedVideo, setSelectedVideo] = useState(null);
            const [startTime, setStartTime] = useState(null); 
            const [reloadKey, setReloadKey] = useState(0); 
            const [activeCategory, setActiveCategory] = useState('all');
            const [searchTerm, setSearchTerm] = useState("");
            const [searchResults, setSearchResults] = useState([]); 
            const [isSearchingText, setIsSearchingText] = useState(false);
            const [searchMode, setSearchMode] = useState('all'); // 'all' or 'subtitle_only'
            
            // Mobile Navigation State
            const [activeTab, setActiveTab] = useState('video');
            
            // URL State Sync
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const vid = params.get('video');
                const time = params.get('t');
                
                if (vid) {
                    // Find video logic needs data loaded first
                    // We handle the selection after videos are loaded
                }
                if (time) setStartTime(parseInt(time));
            }, []);

            const updateUrl = (videoId, time) => {
                const url = new URL(window.location);
                if (videoId) url.searchParams.set('video', videoId);
                else url.searchParams.delete('video');
                
                if (time && time > 0) url.searchParams.set('t', Math.floor(time));
                else url.searchParams.delete('t');
                
                window.history.pushState({}, '', url);
            };

            const isMobile = window.innerWidth < 768;
            const isSearchActive = cleanSearch(searchTerm).length > 0;

            const handleSeekComment = (seconds) => {
                setStartTime(seconds);
                setReloadKey(prev => prev + 1); 
                if(isMobile) setActiveTab('video');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                updateUrl(selectedVideo?.embedId, seconds);
            };

            const handleSelectVideo = (video, startSeconds = null) => {
                setSelectedVideo(video);
                setStartTime(startSeconds);
                setReloadKey(prev => prev + 1);
                updateUrl(video.embedId, startSeconds);
                if(isMobile) setActiveTab('video');
            };

            // Data Fetch
            useEffect(() => {
                const fetchVideos = async () => {
                    try {
                        const response = await fetch(`videos.json?t=${new Date().getTime()}`);
                        if (!response.ok) throw new Error("Dosya bulunamadƒ±");
                        const data = await response.json();
                        const rawVideos = Array.isArray(data) ? data : (data.videos || []);
                        const tarih = Array.isArray(data) ? "" : (data.tarih || "");
                        setLastUpdate(tarih);
                        const processed = processVideoData(rawVideos);
                        setVideos(processed);
                        
                        // Check URL params after load
                        const params = new URLSearchParams(window.location.search);
                        const vid = params.get('video');
                        if(vid) {
                            const found = processed.find(v => v.embedId === vid);
                            if(found) setSelectedVideo(found);
                        }

                    } catch (error) {
                        console.warn("videos.json y√ºklenemedi, yedek veri kullanƒ±lƒ±yor.", error);
                        const processed = processVideoData(FALLBACK_DATA.videos);
                        setLastUpdate(FALLBACK_DATA.tarih);
                        setVideos(processed);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchVideos();
            }, []);

            // Search Logic
            useEffect(() => {
                if (!isSearchActive) {
                    setSearchResults([]); 
                    setIsSearchingText(false);
                    return;
                }
                
                const performSearch = async () => {
                    setIsSearchingText(true);
                    const term = cleanSearch(searchTerm).toLowerCase();
                    if (videos.length === 0) return;

                    const videosToSearch = videos.filter(v => 
                        activeCategory === 'all' || normalizeText(v.category) === normalizeText(activeCategory)
                    );

                    // Filter Title matches
                    let results = [];
                    
                    if (searchMode === 'all') {
                        const titleMatches = videosToSearch.filter(v => normalizeText(v.title).includes(term));
                        results = titleMatches.map(v => ({
                            type: 'video',
                            video: v,
                            id: `video-${v.id}`,
                            isActive: false
                        }));
                    }

                    // Filter Subtitle matches (Always checks unless restricted by logic, here checking all txt files)
                    // Optimization: Don't fetch txt if searchMode is 'title_only' (not implemented here, assuming 'subtitle_only' or 'all')
                    if (searchMode !== 'title_only') { 
                        // Since we don't have a backend search, we simulate "Subtitle Only" by just removing title matches from results if that mode is selected, 
                        // OR (better UX) just fetch subtitles and combine. 
                        // Implementation: Fetch all subtitles.
                        
                        const fetchPromises = videosToSearch.map(async (v) => {
                            const path = getTxtPath(v.title);
                            try {
                                const res = await fetch(path);
                                if (!res.ok) return [];
                                const content = await res.text();
                                const lines = content.split('\n');
                                const hits = [];
                                lines.forEach(line => {
                                    if (line.toLowerCase().includes(term)) {
                                        const timeMatch = line.match(/\[(\d{2}):(\d{2}):(\d{2})\]/);
                                        if (timeMatch) {
                                            const totalSeconds = parseInt(timeMatch[1])*3600 + parseInt(timeMatch[2])*60 + parseInt(timeMatch[3]);
                                            hits.push({
                                                type: 'timestamp',
                                                video: v,
                                                timestamp: `${timeMatch[1]}:${timeMatch[2]}:${timeMatch[3]}`,
                                                seconds: totalSeconds,
                                                snippet: line.replace(timeMatch[0], '').trim(),
                                                id: `ts-${v.id}-${totalSeconds}`,
                                                searchTerm: term
                                            });
                                        }
                                    }
                                });
                                return hits;
                            } catch (e) { return []; }
                        });

                        const textHitsArrays = await Promise.all(fetchPromises);
                        const allTextHits = textHitsArrays.flat();
                        
                        if (searchMode === 'subtitle_only') {
                             results = allTextHits;
                        } else {
                             // Merge: Timestamps first, then Videos
                             results = [...allTextHits, ...results];
                        }
                    }

                    setSearchResults(results);
                    setIsSearchingText(false);
                };

                const timer = setTimeout(performSearch, 600); // Debounce
                return () => clearTimeout(timer);
            }, [searchTerm, videos, activeCategory, searchMode]); 

            const displayVideos = useMemo(() => {
                if (activeCategory === 'all') return videos;
                return videos.filter(video => normalizeText(video.category) === normalizeText(activeCategory));
            }, [activeCategory, videos]);

            return (
                <div className={`min-h-screen flex flex-col ${isMobile ? 'pb-24' : 'pb-12'}`}>
                    <Navbar 
                        categories={CATEGORIES} 
                        activeCategory={activeCategory} 
                        setActiveCategory={setActiveCategory} 
                        lastUpdate={lastUpdate}
                        isMobile={isMobile}
                    />

                    <main className="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 relative">
                            
                            {/* LEFT COLUMN (Video Player & Info) */}
                            {/* Desktop: Always visible. Mobile: Visible only if activeTab === 'video' */}
                            <div className={`${isMobile && activeTab !== 'video' ? 'hidden' : 'block'} lg:col-span-8 space-y-6 animate-fade-in`}>
                                <VideoPlayer video={selectedVideo} startTime={startTime} reloadKey={reloadKey} />
                                
                                {selectedVideo ? (
                                    <div className="p-5 rounded-2xl bg-slate-900/40 border border-white/5 flex flex-col gap-3 animate-slide-up">
                                        <div>
                                            <h2 className="text-lg md:text-xl font-bold text-white leading-tight">{selectedVideo.title}</h2>
                                            <div className="flex items-center gap-3 mt-2 text-xs text-slate-400">
                                                <span className="bg-indigo-500/10 text-indigo-400 px-2 py-1 rounded border border-indigo-500/20 font-medium">{selectedVideo.category}</span>
                                                <span>‚Ä¢</span>
                                                <span>{selectedVideo.date.toLocaleDateString('tr-TR')}</span>
                                                {startTime && <span>‚Ä¢ <span className="text-indigo-300 font-mono">Konum: {formatTime(startTime)}</span></span>}
                                            </div>
                                        </div>
                                        {/* Desktop Comment Section (Moved here for better layout) */}
                                        {!isMobile && (
                                            <div className="mt-4 pt-4 border-t border-white/5">
                                                <CommentSection videoId={selectedVideo.embedId} onSeek={handleSeekComment} />
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <CommentGuideBox />
                                )}

                                {/* Mobile Comments (Only show in Comments Tab on mobile) */}
                                {isMobile && activeTab === 'comments' && selectedVideo && (
                                    <CommentSection videoId={selectedVideo.embedId} onSeek={handleSeekComment} />
                                )}
                            </div>

                            {/* RIGHT COLUMN (Search & List) */}
                            {/* Desktop: Always visible. Mobile: Visible only if activeTab === 'search' */}
                            <div className={`${isMobile && activeTab !== 'search' ? 'hidden' : 'block'} lg:col-span-4 space-y-4 animate-slide-up`}>
                                {/* Search Bar */}
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg className="h-4 w-4 text-slate-500 group-focus-within:text-indigo-500 transition-colors" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                    </div>
                                    <input
                                        type="text"
                                        placeholder="Kelime, c√ºmle veya ki≈üi ara..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(cleanSearch(e.target.value))}
                                        className="w-full bg-slate-900/50 border border-white/10 text-slate-100 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 block w-full pl-10 p-3 transition-all duration-300 placeholder:text-slate-600"
                                    />
                                </div>

                                {/* Search Options */}
                                {isSearchActive && (
                                    <div className="flex items-center gap-2 bg-slate-900/30 p-2 rounded-lg border border-white/5 text-xs animate-fade-in">
                                        <span className="text-slate-400 pl-2">Aranacak Yer:</span>
                                        <button 
                                            onClick={() => setSearchMode('all')}
                                            className={`px-3 py-1 rounded transition-colors ${searchMode === 'all' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}`}
                                        >
                                            T√ºm√º
                                        </button>
                                        <button 
                                            onClick={() => setSearchMode('subtitle_only')}
                                            className={`px-3 py-1 rounded transition-colors ${searchMode === 'subtitle_only' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}`}
                                        >
                                            Sadece Altyazƒ±
                                        </button>
                                    </div>
                                )}

                                {/* Results Header */}
                                <div className="flex items-center justify-between px-2 py-1">
                                    <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                        {isSearchingText ? (
                                            <span className="animate-pulse text-indigo-400">üîé Taranƒ±yor...</span>
                                        ) : isSearchActive ? (
                                            <span>{searchResults.length} Sonu√ß bulundu</span>
                                        ) : (
                                            <span>{displayVideos.length} Video</span>
                                        )}
                                    </h3>
                                    {isSearchActive && (
                                        <button onClick={() => setSearchTerm('')} className="text-[10px] text-slate-500 hover:text-white underline">Temizle</button>
                                    )}
                                </div>

                                {/* Scrollable List */}
                                <div className="overflow-y-auto h-[calc(100vh-250px)] lg:h-[650px] pr-2 space-y-2 pb-10">
                                    {loading ? (
                                        <div className="text-center py-12 text-slate-500">Veriler y√ºkleniyor...</div>
                                    ) : isSearchActive ? (
                                        searchResults.length > 0 ? (
                                            searchResults.map((item, idx) => (
                                                <div key={item.id || idx} style={{ animationDelay: `${idx * 50}ms` }}>
                                                    <SearchResultItem
                                                        item={item}
                                                        onClick={(vid, sec) => handleSelectVideo(vid, sec)}
                                                    />
                                                </div>
                                            ))
                                        ) : (
                                            <div className="text-center py-8 px-4 bg-slate-900/20 rounded-xl border border-dashed border-white/10">
                                                <div className="text-2xl mb-2">üçÉ</div>
                                                <p className="text-slate-400 text-sm">Sonu√ß bulunamadƒ±.</p>
                                            </div>
                                        )
                                    ) : (
                                        displayVideos.map((video) => (
                                            <ThumbnailCard
                                                key={video.id}
                                                video={video}
                                                isActive={selectedVideo?.id === video.id}
                                                onClick={() => handleSelectVideo(video)}
                                            />
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    <footer className="border-t border-white/5 mt-12 py-8 bg-black/20 backdrop-blur-sm text-center hidden md:block">
                        <p className="text-slate-600 text-sm">¬© 2025 Katman Yayƒ±n Ge√ßmi≈üi Ar≈üiv. React & Firebase Powered.</p>
                    </footer>

                    {isMobile && <MobileNav activeTab={activeTab} setActiveTab={setActiveTab} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
